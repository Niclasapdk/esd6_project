#include "distortion.h"

static Int16 drive = 32767; // Q6.9

#define tanhLUT_len 1024
#define tanhFactor 21824 // should be changed if LUT len changes (see implementation of tanh dist)
// tanh saturation limits
static const Int16 tanhLUT_xmax = (3 << 9);
static const Int16 tanhLUT_xmin = -(3 << 9);
static const Int16 tanhLUT[tanhLUT_len] = {
   -32606, -32604, -32602, -32600, -32598, -32596, -32594, -32592, 
   -32590, -32588, -32586, -32584, -32582, -32579, -32577, -32575, 
   -32573, -32570, -32568, -32566, -32563, -32561, -32558, -32556, 
   -32553, -32551, -32548, -32546, -32543, -32541, -32538, -32535, 
   -32532, -32530, -32527, -32524, -32521, -32518, -32515, -32512, 
   -32509, -32506, -32503, -32500, -32497, -32494, -32491, -32487, 
   -32484, -32481, -32477, -32474, -32470, -32467, -32463, -32460, 
   -32456, -32453, -32449, -32445, -32441, -32437, -32434, -32430, 
   -32426, -32422, -32418, -32413, -32409, -32405, -32401, -32397, 
   -32392, -32388, -32383, -32379, -32374, -32370, -32365, -32360, 
   -32355, -32351, -32346, -32341, -32336, -32331, -32326, -32320, 
   -32315, -32310, -32304, -32299, -32293, -32288, -32282, -32277, 
   -32271, -32265, -32259, -32253, -32247, -32241, -32235, -32229, 
   -32222, -32216, -32210, -32203, -32196, -32190, -32183, -32176, 
   -32169, -32162, -32155, -32148, -32141, -32133, -32126, -32118, 
   -32111, -32103, -32095, -32088, -32080, -32072, -32063, -32055, 
   -32047, -32039, -32030, -32021, -32013, -32004, -31995, -31986, 
   -31977, -31968, -31958, -31949, -31939, -31930, -31920, -31910, 
   -31900, -31890, -31880, -31869, -31859, -31848, -31838, -31827, 
   -31816, -31805, -31794, -31782, -31771, -31759, -31748, -31736, 
   -31724, -31712, -31699, -31687, -31674, -31662, -31649, -31636, 
   -31623, -31609, -31596, -31582, -31569, -31555, -31541, -31527, 
   -31512, -31498, -31483, -31468, -31453, -31438, -31423, -31407, 
   -31391, -31375, -31359, -31343, -31327, -31310, -31293, -31276, 
   -31259, -31242, -31224, -31206, -31188, -31170, -31152, -31133, 
   -31114, -31095, -31076, -31057, -31037, -31017, -30997, -30977, 
   -30956, -30935, -30914, -30893, -30871, -30850, -30828, -30806, 
   -30783, -30760, -30737, -30714, -30691, -30667, -30643, -30619, 
   -30594, -30570, -30544, -30519, -30493, -30468, -30441, -30415, 
   -30388, -30361, -30334, -30306, -30278, -30250, -30221, -30193, 
   -30163, -30134, -30104, -30074, -30043, -30013, -29982, -29950, 
   -29918, -29886, -29854, -29821, -29788, -29754, -29720, -29686, 
   -29651, -29616, -29581, -29545, -29509, -29472, -29435, -29398, 
   -29360, -29322, -29284, -29245, -29206, -29166, -29126, -29085, 
   -29044, -29003, -28961, -28919, -28876, -28833, -28789, -28745, 
   -28701, -28656, -28610, -28564, -28518, -28471, -28424, -28376, 
   -28328, -28279, -28230, -28180, -28129, -28079, -28027, -27975, 
   -27923, -27870, -27817, -27763, -27708, -27653, -27598, -27542, 
   -27485, -27428, -27370, -27311, -27252, -27193, -27133, -27072, 
   -27011, -26949, -26886, -26823, -26759, -26695, -26630, -26565, 
   -26498, -26432, -26364, -26296, -26227, -26158, -26088, -26017, 
   -25946, -25874, -25801, -25728, -25654, -25579, -25503, -25427, 
   -25351, -25273, -25195, -25116, -25036, -24956, -24875, -24793, 
   -24711, -24627, -24543, -24459, -24373, -24287, -24200, -24112, 
   -24024, -23934, -23844, -23753, -23662, -23569, -23476, -23382, 
   -23288, -23192, -23096, -22999, -22901, -22802, -22703, -22602, 
   -22501, -22399, -22296, -22193, -22088, -21983, -21877, -21770, 
   -21662, -21554, -21444, -21334, -21223, -21111, -20998, -20884, 
   -20770, -20654, -20538, -20421, -20303, -20184, -20064, -19944, 
   -19822, -19700, -19577, -19453, -19328, -19202, -19075, -18948, 
   -18820, -18690, -18560, -18429, -18298, -18165, -18031, -17897, 
   -17762, -17625, -17488, -17350, -17212, -17072, -16932, -16790, 
   -16648, -16505, -16361, -16217, -16071, -15925, -15778, -15630, 
   -15481, -15331, -15180, -15029, -14877, -14724, -14570, -14416, 
   -14260, -14104, -13947, -13789, -13631, -13471, -13311, -13150, 
   -12989, -12826, -12663, -12499, -12335, -12170, -12004, -11837, 
   -11669, -11501, -11332, -11163, -10993, -10822, -10650, -10478, 
   -10305, -10131,  -9957,  -9783,  -9607,  -9431,  -9255,  -9078, 
    -8900,  -8722,  -8543,  -8363,  -8183,  -8003,  -7822,  -7640, 
    -7458,  -7276,  -7093,  -6910,  -6726,  -6541,  -6357,  -6172, 
    -5986,  -5800,  -5614,  -5427,  -5240,  -5052,  -4865,  -4676, 
    -4488,  -4299,  -4110,  -3921,  -3731,  -3542,  -3352,  -3161, 
    -2971,  -2780,  -2589,  -2398,  -2207,  -2015,  -1824,  -1632, 
    -1440,  -1249,  -1057,   -865,   -673,   -480,   -288,    -96, 
       96,    288,    480,    673,    865,   1057,   1249,   1440, 
     1632,   1824,   2015,   2207,   2398,   2589,   2780,   2971, 
     3161,   3352,   3542,   3731,   3921,   4110,   4299,   4488, 
     4676,   4865,   5052,   5240,   5427,   5614,   5800,   5986, 
     6172,   6357,   6541,   6726,   6910,   7093,   7276,   7458, 
     7640,   7822,   8003,   8183,   8363,   8543,   8722,   8900, 
     9078,   9255,   9431,   9607,   9783,   9957,  10131,  10305, 
    10478,  10650,  10822,  10993,  11163,  11332,  11501,  11669, 
    11837,  12004,  12170,  12335,  12499,  12663,  12826,  12989, 
    13150,  13311,  13471,  13631,  13789,  13947,  14104,  14260, 
    14416,  14570,  14724,  14877,  15029,  15180,  15331,  15481, 
    15630,  15778,  15925,  16071,  16217,  16361,  16505,  16648, 
    16790,  16932,  17072,  17212,  17350,  17488,  17625,  17762, 
    17897,  18031,  18165,  18298,  18429,  18560,  18690,  18820, 
    18948,  19075,  19202,  19328,  19453,  19577,  19700,  19822, 
    19944,  20064,  20184,  20303,  20421,  20538,  20654,  20770, 
    20884,  20998,  21111,  21223,  21334,  21444,  21554,  21662, 
    21770,  21877,  21983,  22088,  22193,  22296,  22399,  22501, 
    22602,  22703,  22802,  22901,  22999,  23096,  23192,  23288, 
    23382,  23476,  23569,  23662,  23753,  23844,  23934,  24024, 
    24112,  24200,  24287,  24373,  24459,  24543,  24627,  24711, 
    24793,  24875,  24956,  25036,  25116,  25195,  25273,  25351, 
    25427,  25503,  25579,  25654,  25728,  25801,  25874,  25946, 
    26017,  26088,  26158,  26227,  26296,  26364,  26432,  26498, 
    26565,  26630,  26695,  26759,  26823,  26886,  26949,  27011, 
    27072,  27133,  27193,  27252,  27311,  27370,  27428,  27485, 
    27542,  27598,  27653,  27708,  27763,  27817,  27870,  27923, 
    27975,  28027,  28079,  28129,  28180,  28230,  28279,  28328, 
    28376,  28424,  28471,  28518,  28564,  28610,  28656,  28701, 
    28745,  28789,  28833,  28876,  28919,  28961,  29003,  29044, 
    29085,  29126,  29166,  29206,  29245,  29284,  29322,  29360, 
    29398,  29435,  29472,  29509,  29545,  29581,  29616,  29651, 
    29686,  29720,  29754,  29788,  29821,  29854,  29886,  29918, 
    29950,  29982,  30013,  30043,  30074,  30104,  30134,  30163, 
    30193,  30221,  30250,  30278,  30306,  30334,  30361,  30388, 
    30415,  30441,  30468,  30493,  30519,  30544,  30570,  30594, 
    30619,  30643,  30667,  30691,  30714,  30737,  30760,  30783, 
    30806,  30828,  30850,  30871,  30893,  30914,  30935,  30956, 
    30977,  30997,  31017,  31037,  31057,  31076,  31095,  31114, 
    31133,  31152,  31170,  31188,  31206,  31224,  31242,  31259, 
    31276,  31293,  31310,  31327,  31343,  31359,  31375,  31391, 
    31407,  31423,  31438,  31453,  31468,  31483,  31498,  31512, 
    31527,  31541,  31555,  31569,  31582,  31596,  31609,  31623, 
    31636,  31649,  31662,  31674,  31687,  31699,  31712,  31724, 
    31736,  31748,  31759,  31771,  31782,  31794,  31805,  31816, 
    31827,  31838,  31848,  31859,  31869,  31880,  31890,  31900, 
    31910,  31920,  31930,  31939,  31949,  31958,  31968,  31977, 
    31986,  31995,  32004,  32013,  32021,  32030,  32039,  32047, 
    32055,  32063,  32072,  32080,  32088,  32095,  32103,  32111, 
    32118,  32126,  32133,  32141,  32148,  32155,  32162,  32169, 
    32176,  32183,  32190,  32196,  32203,  32210,  32216,  32222, 
    32229,  32235,  32241,  32247,  32253,  32259,  32265,  32271, 
    32277,  32282,  32288,  32293,  32299,  32304,  32310,  32315, 
    32320,  32326,  32331,  32336,  32341,  32346,  32351,  32355, 
    32360,  32365,  32370,  32374,  32379,  32383,  32388,  32392, 
    32397,  32401,  32405,  32409,  32413,  32418,  32422,  32426, 
    32430,  32434,  32437,  32441,  32445,  32449,  32453,  32456, 
    32460,  32463,  32467,  32470,  32474,  32477,  32481,  32484, 
    32487,  32491,  32494,  32497,  32500,  32503,  32506,  32509, 
    32512,  32515,  32518,  32521,  32524,  32527,  32530,  32532, 
    32535,  32538,  32541,  32543,  32546,  32548,  32551,  32553, 
    32556,  32558,  32561,  32563,  32566,  32568,  32570,  32573, 
    32575,  32577,  32579,  32582,  32584,  32586,  32588,  32590, 
    32592,  32594,  32596,  32598,  32600,  32602,  32604,  32606
};

Int16 distLowpass(Int16 x) {
	// y[n] = (1 - alpha) * y[n-1] + alpha * x[n]
	static Int16 yOld = 0;
	Int16 y;
	y = ((28416*(Int32)yOld) + (4351*(Int32)x))>>15;
	yOld = y;
	return y;
}

Int16 tanhDistortion(Int16 x) {
	Uint16 idx;
	Int16 y;
	
	// Scale input by drive (result is Q3.12)
	x = ((Int32)x * (Int32)drive)>>15;
	
	// Check if input range saturates tanh
	if (x >= tanhLUT_xmax) {
		y = 32767; // saturate tanh = 1
	} else if (x <= tanhLUT_xmin) {
		y = -32768; // saturate tanh = -1
	} else {
		// Get output from LUT
		// index = ((q3_12_input + (3 << 12)) * factor) >> 16
		// factor = round(((tanhLUT_len - 1) << 16) / (6 << 12))
		idx = ((Int32)((Int32)x + (3 << 9)) * tanhFactor)>>16;
		y = tanhLUT[idx];
	}
	y = distLowpass(y);
	return y;
}
