#include "distortion.h"

static Int16 drive = 32767; // Q1.14

#define tanhLUT_len 1024
static const Int16 tanhLUT[tanhLUT_len] = {
   -31589, -31580, -31571, -31562, -31553, -31543, -31534, -31524, 
   -31515, -31505, -31495, -31485, -31476, -31466, -31456, -31446, 
   -31435, -31425, -31415, -31404, -31394, -31383, -31373, -31362, 
   -31351, -31340, -31329, -31318, -31307, -31296, -31285, -31273, 
   -31262, -31250, -31239, -31227, -31215, -31203, -31191, -31179, 
   -31167, -31155, -31142, -31130, -31117, -31105, -31092, -31079, 
   -31066, -31053, -31040, -31027, -31014, -31000, -30987, -30973, 
   -30960, -30946, -30932, -30918, -30904, -30889, -30875, -30861, 
   -30846, -30831, -30817, -30802, -30787, -30772, -30757, -30741, 
   -30726, -30710, -30695, -30679, -30663, -30647, -30631, -30615, 
   -30598, -30582, -30565, -30549, -30532, -30515, -30498, -30481, 
   -30463, -30446, -30428, -30410, -30393, -30375, -30357, -30338, 
   -30320, -30302, -30283, -30264, -30245, -30226, -30207, -30188, 
   -30168, -30149, -30129, -30109, -30089, -30069, -30049, -30028, 
   -30007, -29987, -29966, -29945, -29924, -29902, -29881, -29859, 
   -29837, -29815, -29793, -29771, -29748, -29726, -29703, -29680, 
   -29657, -29634, -29610, -29587, -29563, -29539, -29515, -29491, 
   -29466, -29442, -29417, -29392, -29367, -29341, -29316, -29290, 
   -29265, -29239, -29212, -29186, -29159, -29133, -29106, -29079, 
   -29051, -29024, -28996, -28968, -28940, -28912, -28883, -28854, 
   -28826, -28797, -28767, -28738, -28708, -28678, -28648, -28618, 
   -28588, -28557, -28526, -28494, -28463, -28432, -28400, -28368, 
   -28336, -28303, -28271, -28238, -28205, -28172, -28138, -28104, 
   -28070, -28036, -28002, -27967, -27932, -27897, -27861, -27826, 
   -27790, -27754, -27717, -27681, -27644, -27607, -27570, -27532, 
   -27495, -27457, -27418, -27379, -27340, -27301, -27262, -27223, 
   -27183, -27143, -27102, -27062, -27021, -26980, -26939, -26897, 
   -26855, -26813, -26771, -26728, -26684, -26641, -26597, -26554, 
   -26510, -26465, -26420, -26376, -26330, -26285, -26239, -26193, 
   -26147, -26100, -26053, -26006, -25958, -25910, -25862, -25813, 
   -25764, -25715, -25666, -25617, -25567, -25516, -25466, -25415, 
   -25364, -25312, -25261, -25208, -25155, -25103, -25050, -24996, 
   -24942, -24888, -24834, -24780, -24725, -24669, -24614, -24558, 
   -24501, -24445, -24388, -24331, -24272, -24214, -24156, -24097, 
   -24038, -23979, -23919, -23859, -23799, -23739, -23678, -23616, 
   -23555, -23492, -23430, -23367, -23304, -23240, -23176, -23112, 
   -23047, -22983, -22917, -22852, -22786, -22720, -22653, -22586, 
   -22519, -22451, -22383, -22314, -22245, -22175, -22106, -22036, 
   -21965, -21895, -21824, -21752, -21680, -21608, -21536, -21463, 
   -21390, -21316, -21242, -21168, -21093, -21016, -20941, -20865, 
   -20789, -20712, -20635, -20558, -20480, -20402, -20323, -20244, 
   -20165, -20085, -20005, -19924, -19843, -19761, -19679, -19597, 
   -19515, -19432, -19349, -19265, -19181, -19097, -19012, -18927, 
   -18842, -18756, -18670, -18583, -18496, -18409, -18319, -18231, 
   -18143, -18054, -17964, -17875, -17785, -17694, -17603, -17512, 
   -17420, -17328, -17236, -17143, -17050, -16956, -16861, -16767, 
   -16672, -16577, -16482, -16386, -16290, -16193, -16096, -15999, 
   -15901, -15803, -15705, -15606, -15507, -15407, -15306, -15205, 
   -15105, -15004, -14903, -14801, -14699, -14596, -14494, -14390, 
   -14287, -14183, -14079, -13974, -13869, -13764, -13657, -13551, 
   -13445, -13338, -13231, -13124, -13016, -12908, -12800, -12691, 
   -12582, -12473, -12363, -12254, -12143, -12033, -11922, -11809, 
   -11697, -11585, -11473, -11361, -11248, -11135, -11022, -10908, 
   -10794, -10680, -10565, -10450, -10335, -10220, -10104,  -9986, 
    -9870,  -9754,  -9637,  -9520,  -9402,  -9285,  -9167,  -9049, 
    -8930,  -8812,  -8693,  -8574,  -8455,  -8335,  -8215,  -8093, 
    -7973,  -7852,  -7732,  -7611,  -7489,  -7368,  -7246,  -7124, 
    -7002,  -6880,  -6758,  -6635,  -6512,  -6389,  -6266,  -6141, 
    -6017,  -5893,  -5769,  -5645,  -5521,  -5396,  -5272,  -5147, 
    -5022,  -4897,  -4772,  -4646,  -4521,  -4395,  -4270,  -4144, 
    -4016,  -3890,  -3763,  -3637,  -3510,  -3384,  -3257,  -3130, 
    -3004,  -2877,  -2750,  -2622,  -2495,  -2368,  -2240,  -2113, 
    -1984,  -1856,  -1728,  -1601,  -1473,  -1345,  -1217,  -1090, 
     -962,   -834,   -706,   -578,   -450,   -322,   -194,    -66, 
       64,    192,    320,    448,    576,    704,    832,    960, 
     1088,   1215,   1343,   1471,   1599,   1726,   1854,   1982, 
     2111,   2239,   2366,   2493,   2620,   2748,   2875,   3002, 
     3128,   3255,   3382,   3508,   3635,   3761,   3888,   4014, 
     4142,   4268,   4393,   4519,   4645,   4770,   4895,   5020, 
     5145,   5270,   5394,   5519,   5643,   5767,   5891,   6015, 
     6139,   6264,   6387,   6510,   6633,   6756,   6878,   7000, 
     7123,   7244,   7366,   7487,   7609,   7730,   7850,   7971, 
     8091,   8213,   8333,   8453,   8572,   8691,   8810,   8929, 
     9047,   9165,   9283,   9401,   9518,   9635,   9752,   9868, 
     9985,  10102,  10218,  10333,  10449,  10563,  10678,  10792, 
    10906,  11020,  11133,  11246,  11359,  11472,  11584,  11696, 
    11807,  11920,  12031,  12142,  12252,  12362,  12471,  12581, 
    12690,  12798,  12907,  13015,  13122,  13230,  13336,  13443, 
    13549,  13655,  13763,  13868,  13973,  14077,  14181,  14285, 
    14389,  14492,  14595,  14697,  14799,  14901,  15002,  15103, 
    15204,  15304,  15406,  15505,  15604,  15703,  15802,  15900, 
    15997,  16095,  16192,  16288,  16384,  16480,  16575,  16671, 
    16765,  16860,  16955,  17048,  17142,  17234,  17327,  17419, 
    17510,  17602,  17693,  17783,  17873,  17963,  18052,  18141, 
    18230,  18318,  18407,  18495,  18582,  18668,  18755,  18840, 
    18926,  19011,  19096,  19180,  19264,  19348,  19431,  19514, 
    19596,  19678,  19760,  19842,  19923,  20004,  20084,  20163, 
    20243,  20322,  20400,  20478,  20556,  20634,  20711,  20787, 
    20864,  20940,  21015,  21092,  21166,  21241,  21315,  21388, 
    21462,  21535,  21607,  21679,  21751,  21823,  21894,  21964, 
    22035,  22104,  22174,  22244,  22313,  22382,  22450,  22517, 
    22585,  22652,  22719,  22785,  22851,  22916,  22982,  23046, 
    23111,  23175,  23239,  23303,  23366,  23429,  23491,  23554, 
    23615,  23677,  23738,  23798,  23859,  23919,  23978,  24037, 
    24096,  24155,  24213,  24271,  24330,  24387,  24444,  24501, 
    24557,  24613,  24668,  24724,  24779,  24833,  24888,  24942, 
    24995,  25049,  25102,  25154,  25208,  25260,  25312,  25363, 
    25414,  25465,  25516,  25566,  25616,  25665,  25715,  25764, 
    25812,  25861,  25909,  25957,  26005,  26052,  26099,  26146, 
    26192,  26238,  26284,  26330,  26375,  26420,  26464,  26509, 
    26553,  26597,  26640,  26684,  26727,  26770,  26812,  26854, 
    26896,  26938,  26979,  27020,  27061,  27102,  27142,  27182, 
    27222,  27262,  27301,  27340,  27379,  27418,  27456,  27494, 
    27532,  27569,  27607,  27644,  27680,  27717,  27753,  27789, 
    27825,  27861,  27896,  27931,  27966,  28001,  28036,  28070, 
    28104,  28138,  28171,  28204,  28237,  28270,  28303,  28335, 
    28367,  28399,  28431,  28463,  28494,  28526,  28556,  28587, 
    28618,  28648,  28678,  28708,  28737,  28767,  28796,  28825, 
    28854,  28883,  28911,  28939,  28967,  28996,  29023,  29051, 
    29078,  29105,  29132,  29159,  29186,  29212,  29238,  29264, 
    29290,  29316,  29341,  29366,  29391,  29417,  29442,  29466, 
    29490,  29515,  29539,  29563,  29586,  29610,  29633,  29657, 
    29680,  29703,  29725,  29748,  29770,  29793,  29815,  29837, 
    29859,  29880,  29902,  29923,  29945,  29966,  29986,  30007, 
    30028,  30048,  30068,  30089,  30109,  30128,  30149,  30168, 
    30188,  30207,  30226,  30245,  30264,  30283,  30301,  30320, 
    30338,  30356,  30374,  30392,  30410,  30428,  30446,  30463, 
    30480,  30498,  30515,  30532,  30548,  30565,  30582,  30598, 
    30614,  30631,  30647,  30663,  30679,  30694,  30710,  30726, 
    30741,  30756,  30772,  30787,  30802,  30816,  30831,  30846, 
    30860,  30875,  30889,  30903,  30917,  30931,  30945,  30959, 
    30973,  30987,  31000,  31013,  31027,  31040,  31053,  31066, 
    31079,  31092,  31104,  31117,  31130,  31142,  31154,  31167, 
    31179,  31191,  31203,  31215,  31227,  31238,  31250,  31262, 
    31273,  31284,  31296,  31307,  31318,  31329,  31340,  31351, 
    31362,  31373,  31383,  31394,  31404,  31415,  31425,  31435, 
    31445,  31455,  31465,  31475,  31485,  31495,  31505,  31515, 
    31524,  31534,  31543,  31552,  31562,  31571,  31580,  31589
};

Int16 tanhDistortion(Int16 x) {
	Uint16 idx;
	Int16 y;
	x = ((Int32)x * (Int32)drive)>>15;
	idx = ((Int32)((Int32)x + 32768) * (tanhLUT_len-1))>>16;
	y = tanhLUT[idx];
	return y;
}